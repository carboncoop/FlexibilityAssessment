<template>
    <div id='assessment-table-component'>
        <table class="table">
            <th>Name</th><th>Description</th><th>Postcode</th><th v-if="administratorView === true">Author</th><th>Modified</th><th><button v-b-modal.new-assessment-modal dusk="new-button">New</button></th>
            <tr v-for="assessment in assessmentsList">
                <td v-text="assessment.name"></td>
                <td v-text="assessment.description"></td>
                <td v-text="assessment.postcode"></td>
                <td v-text="assessment.owner_name"  v-if="administratorView === true"></td>
                <td v-text="assessment.updated_at"></td>
                <td class='assessment-actions'>
                    <button><a class="open-assessment" v-bind:assessment-id="assessment.id" v-bind:href="'/assessment/' + assessment.id + '/edit'"><font-awesome-icon icon="edit" size="xs" title="Open" style="cursor:pointer" /></a></button>
                    <button v-b-modal.delete-assessment-modal class="delete-button" v-bind:assessment-name="assessment.name" v-on:click="setAssessmentToDelete(assessment.id)"><font-awesome-icon icon="trash" size="xs" title="Delete" style="cursor:pointer" /></button>
                </td>
            </tr>
        </table>

        <b-modal id="new-assessment-modal" ref="newAssessmentModal" title="New assessment" 
                 v-on:ok="createAssessment" 
                 v-on:show="error=false" 
                 v-on:hidden="newAssessment.name=''; newAssessment.description=''">
            <p style="color:red" v-if="error">{{error}}</p>
            <table>
                <tr><td>Name*</td><td><input type="text" name="name" class="form-control" v-model="newAssessment.name" placeholder="My asessment"></td></tr>
                <tr><td>Description</td><td><input type="text" name="description" class="form-control" v-model="newAssessment.description" placeholder="Description"></td></tr>
                <tr><td>Address 1</td><td><input type="text" name="address1" class="form-control" v-model="newAssessment.address1" placeholder="Address 1"></td></tr>
                <tr><td>Address 2</td><td><input type="text" name="address2" class="form-control" v-model="newAssessment.address2" placeholder="Address 2"></td></tr>
                <tr><td>Town</td><td><input type="text" name="town" class="form-control" v-model="newAssessment.town" placeholder="Glasgow"></td></tr>
                <tr><td>Postcode*</td><td><input type="text" name="postcode" class="form-control" v-model="newAssessment.postcode" placeholder="G41..."></td></tr>
                <tr><td>Contact email*</td><td><input type="email" name="email" class="form-control" v-model="newAssessment.email" placeholder="myemail@domain.com"></td></tr>
            </table>
        </b-modal>

        <b-modal id="delete-assessment-modal" ref ="deleteAssessmentModal" title="Are you sure you want to delete the assessment?" 
                 v-on:ok="deleteAssessment" 
                 v-on:show="error=false">
            <p style="color:red" v-if="error">{{error}}</p>
            <p>This action cannot be undone</p>
        </b-modal>

    </div>
</template>

<style scoped>
    .assessment-actions{
        min-width:125px;
        padding-left: 12px
    }
</style>

<script>
    export default {
        props: {
            'assessments': Array,
            'administratorView':Boolean
        },
        data: function () {
            return {
                newAssessment: {name: '', description: ''},
                error: false,
                assessmentsList: this.assessments,
                assessmentToDelete: 0
            };
        },
        methods: {
            createAssessment: function (evt) {
                this.error = false;
                evt.preventDefault(); // Prevent modal from closing

                if (!this.newAssessment.name) {
                    this.error = 'Please enter a name';
                }
                else if(!this.newAssessment.postcode) {
                    this.error = 'Please enter a postcode';
                }
                else {
                    axios.post('/api/assessment', this.newAssessment)
                            .then((response) => {
                                this.assessmentsList.push(response.data);
                                this.$refs.newAssessmentModal.hide();
                            })
                            .catch((error) => {
                                this.error = 'Error - ' + (error.response.data.message || error);
                            })
                }
            },
            setAssessmentToDelete: function (id) {
                this.assessmentToDelete = id;
            },
            deleteAssessment: function (evt) {
                evt.preventDefault(); // Prevent modal from closing
                this.error = false;
                axios.delete("/api/assessment/" + this.assessmentToDelete)
                        .then((response) => {
                            let assessmentToDelete = this.assessmentToDelete;
                            let indexOfAssessment = this.assessmentsList.findIndex(function (assessment) {
                                return assessment.id == assessmentToDelete;
                            });
                            this.assessmentsList.splice(indexOfAssessment, 1);
                            this.$refs.deleteAssessmentModal.hide();
                        })
                        .catch((error) => {
                            this.error = 'Error - ' + (error.response.data.message || error);
                        })
            }

        },
        mounted: function () {
            console.log(this.assessments);
        }
    }
</script>
